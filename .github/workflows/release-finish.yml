name: Git Flow Release Finish Test

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g. v1.2.3)'
        required: true

permissions:
  contents: write

jobs:
  finish-release:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Validate release version format
        run: |
          VERSION="${{ github.event.inputs.release_version }}"
          if [[ ! "$VERSION" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "ğŸ”’ Version must follow semantic versioning (e.g. 1.2.3 or v1.2.3)"
            exit 1
          fi

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup branches
        run: |
          ACTOR="${{ github.actor }}"
          git config user.name "$ACTOR"
          git config user.email "${ACTOR}@users.noreply.github.com"
            
            # ëª¨ë“  ë¸Œëœì¹˜ ê°€ì ¸ì˜¤ê¸°
            git fetch --all
            
            # develop ë¸Œëœì¹˜ê°€ ì—†ìœ¼ë©´ ì›ê²©ì—ì„œ ê°€ì ¸ì˜¤ê¸°
            if ! git show-ref --verify --quiet refs/heads/develop; then
              git checkout -b develop origin/develop
            fi

      - name: ğŸ‘¤ Set up Git identity
        run: |
          ACTOR="${{ github.actor }}"
          git config user.name "$ACTOR"
          git config user.email "${ACTOR}@users.noreply.github.com"
          git config core.editor "true"

      - name: ğŸ”§ Install Git Flow (if needed)
        run: |
          # Git Flow ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v git-flow &> /dev/null; then
            echo "ğŸ“¦ Git Flow not found. Installing..."
            
            # OS í™•ì¸ ë° ì„¤ì¹˜
            if command -v apt-get &> /dev/null; then
              # Ubuntu/Debian
              sudo apt-get update
              sudo apt-get install -y git-flow
            elif command -v yum &> /dev/null; then
              # CentOS/RHEL
              sudo yum install -y git-flow
            elif command -v brew &> /dev/null; then
              # macOS
              brew install git-flow
            else
              echo "âŒ Unsupported OS. Please install git-flow manually."
              exit 1
            fi
            
            echo "âœ… Git Flow installed successfully"
          else
            echo "âœ… Git Flow is already installed"
          fi
          
          # Git Flow ë²„ì „ í™•ì¸
          git-flow version

      - name: ğŸš€ Initialize Git Flow
        run: |
          DEVELOP_BRANCH="develop"
          MAIN_BRANCH="main"
          VERSION="${{ github.event.inputs.release_version }}"
          
          echo "ğŸ“¦ Using version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "ğŸ”„ Fetching latest changes..."
          git fetch origin
          
          # Git Flow ì´ˆê¸°í™” ìƒíƒœ í™•ì¸
          if ! git config --get gitflow.branch.master &>/dev/null || ! git flow version &>/dev/null; then
            echo "ğŸ”§ Git Flow not initialized. Initializing..."
            
            # Git Flow ì„¤ì •
            git config gitflow.branch.master "$MAIN_BRANCH"
            git config gitflow.branch.develop "$DEVELOP_BRANCH"
            git config gitflow.prefix.feature "feature/"
            git config gitflow.prefix.release "release/"
            git config gitflow.prefix.hotfix "hotfix/"
            git config gitflow.prefix.support "support/"
            git config gitflow.prefix.versiontag ""
            
            # Git Flow ì´ˆê¸°í™” ì‹¤í–‰
            git flow init -d
            
            echo "âœ… Git Flow initialized successfully"
          else
            echo "âœ… Git Flow is already initialized"
          fi
          
          echo "ğŸ” Current Git Flow configuration:"
          echo "  Master branch: $(git config --get gitflow.branch.master)"
          echo "  Develop branch: $(git config --get gitflow.branch.develop)"
          echo "  Release prefix: $(git config --get gitflow.prefix.release)"

      - name: ğŸ” Validate release branch exists
        run: |
          RELEASE_BRANCH="release/$VERSION"
          
          git fetch origin
          
          if ! git show-ref --verify --quiet "refs/remotes/origin/$RELEASE_BRANCH"; then
            echo "âŒ Release branch '$RELEASE_BRANCH' does not exist on remote"
            exit 1
          fi
          
          echo "âœ… Release branch '$RELEASE_BRANCH' found"

      - name: ğŸ§ª Dry run validation
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          DEVELOP_BRANCH="${{ github.event.inputs.develop_branch }}"
          MAIN_BRANCH="${{ github.event.inputs.main_branch }}"
          RELEASE_BRANCH="release/$VERSION"
          
          echo "ğŸ§ª DRY RUN: Validating Git Flow release finish..."
          
          # íƒœê·¸ ì¤‘ë³µ ê²€ì‚¬
          if git tag -l | grep -q "^$VERSION$"; then
            echo "âŒ Tag '$VERSION' already exists"
            exit 1
          fi
          
          # ë³‘í•© ì¶©ëŒ ê²€ì‚¬
          echo "ğŸ” Checking merge conflicts..."
          
          # develop ë¸Œëœì¹˜ë¡œ ë³‘í•© í…ŒìŠ¤íŠ¸
          git checkout $DEVELOP_BRANCH
          git pull origin $DEVELOP_BRANCH
          if ! git merge --no-commit --no-ff "origin/$RELEASE_BRANCH" &>/dev/null; then
            echo "âŒ Merge conflict detected with $DEVELOP_BRANCH"
            git merge --abort 2>/dev/null || true
            exit 1
          fi
          git reset --hard HEAD
          
          # main ë¸Œëœì¹˜ë¡œ ë³‘í•© í…ŒìŠ¤íŠ¸  
          git checkout $MAIN_BRANCH
          git pull origin $MAIN_BRANCH
          if ! git merge --no-commit --no-ff "origin/$RELEASE_BRANCH" &>/dev/null; then
            echo "âŒ Merge conflict detected with $MAIN_BRANCH"
            git merge --abort 2>/dev/null || true
            exit 1
          fi
          git reset --hard HEAD
          
          echo "âœ… DRY RUN: All validations passed"
          echo "ğŸ“‹ Would execute: git flow release finish $VERSION"

      - name: ğŸ Finish release with Git Flow
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          DEVELOP_BRANCH="${{ github.event.inputs.develop_branch }}"
          MAIN_BRANCH="${{ github.event.inputs.main_branch }}"
          RELEASE_BRANCH="release/$VERSION"
          
          echo "ğŸš€ Starting Git Flow release finish for version $VERSION..."
          
          # release ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
          git checkout "$RELEASE_BRANCH"
          git pull origin "$RELEASE_BRANCH"
          
          # Git Flow release finish ì‹¤í–‰
          # -m: íƒœê·¸ ë©”ì‹œì§€, -p: push, -D: release ë¸Œëœì¹˜ ì‚­ì œ
          git flow release finish -m "Release $VERSION" -p -D "$VERSION"
          
          # íŠ¹ì • íƒœê·¸ í‘¸ì‹œ
          echo "ğŸ· Pushing tag $VERSION..."
          if git tag -l | grep -q "^$VERSION$"; then
            git push origin "$VERSION"
            echo "âœ… Tag $VERSION pushed successfully"
          else
            echo "âŒ Tag $VERSION not found locally"
            exit 1
          fi
          
          echo "âœ… Git Flow release finish completed successfully!"
          echo "ğŸ“‹ Actions performed:"
          echo "  - Merged $RELEASE_BRANCH into $DEVELOP_BRANCH"
          echo "  - Merged $RELEASE_BRANCH into $MAIN_BRANCH"
          echo "  - Created tag: $VERSION"
          echo "  - Pushed tag: $VERSION"
          echo "  - Deleted release branch: $RELEASE_BRANCH"
          echo "  - Pushed all changes to remote"

      - name: ğŸ“Š Summary
        run: |
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ§ª DRY RUN completed for release $VERSION"
          else
            echo "ğŸ‰ Release $VERSION finished successfully!"
            echo "ğŸ· Tag created: $VERSION"
            echo "ğŸ”— Check the releases page: https://github.com/${{ github.repository }}/releases"
          fi
      - name: Post to a Slack channel
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: |
              ğŸ‰ [ë¦´ë¦¬ìŠ¤ ì™„ë£Œ ì•Œë¦¼]

              *ë²„ì „:* `${{ inputs.release_version }}`

              ğŸ”— <https://github.com/${{ github.repository }}/releases|GitHub ë¦´ë¦¬ìŠ¤ í˜ì´ì§€>
              ğŸ“¦ <https://github.com/${{ github.repository }}/releases/tag/${{ inputs.release_version }}|ì´ë²ˆ ë¦´ë¦¬ìŠ¤ ë³´ê¸°>
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: |
                    ğŸ‰ [ë¦´ë¦¬ìŠ¤ ì™„ë£Œ ì•Œë¦¼]

                    *ë²„ì „:* `${{ inputs.release_version }}`

                    ğŸ”— <https://github.com/${{ github.repository }}/releases|GitHub ë¦´ë¦¬ìŠ¤ í˜ì´ì§€>
                    ğŸ“¦ <https://github.com/${{ github.repository }}/releases/tag/${{ inputs.release_version }}|ì´ë²ˆ ë¦´ë¦¬ìŠ¤ ë³´ê¸°> 